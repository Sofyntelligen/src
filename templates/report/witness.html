{% extends 'base/body.html' %}
{% load staticfiles %}
{% block description %}Formulario para realizar un reporte de un testigo con algun problema o con una configruacion
    pendiente.{% endblock %}
{% block title %}Reporte Testigo{% endblock %}
{% block additionalheadexternalafter %}
    <link href="{% static 'dist/css/navbar.css' %}" rel="stylesheet" media="screen">
    {% if history %}
        <link href="{% static 'dist/css/jquery.dataTables.css' %}" rel="stylesheet" media="screen">
        <link href="{% static 'dist/css/select.dataTables.css' %}" rel="stylesheet" media="screen">
        <link href="{% static 'dist/css/dataTables.searchHighlight.css' %}" rel="stylesheet" media="screen">
    {% endif %}
{% endblock %}
{% block headerbutton %}
    <a class="btn btn-outline-warning mr-sm-2" href="{% url 'start_tracing' %}">
        Regresar
    </a>
{% endblock %}
{% block section %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-xl-12">
                <div class="row justify-content-center">
                    {% for data in witness %}
                        <div class="col-xl-8 text-right" style="font-size: 40px;">
                            {{ data.NOMBRE_TESTIGO }}
                        </div>
                        <div class="col-xl-4">
                            ID {{ data.ID_TESTIGO }}
                            <br>
                            MUX {{ data.TIPO_MUX }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-xl-12">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'start_tracing' %}">Inventario de Testigos</a></li>
                    <li class="breadcrumb-item active">Reporte Testigo</li>
                </ol>
            </div>
            {% if history %}
                <div class="col-xl-12">
                    <ul class="nav nav-tabs justify-content-end" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#report" role="tab"
                               aria-controls="home" aria-expanded="true">Reporte</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="profile-tab" data-toggle="tab" href="#historical" role="tab"
                               aria-controls="profile">Historico</a>
                        </li>
                    </ul>
                    <br>
                </div>
                <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="report" role="tabpanel" aria-labelledby="home-tab">
            {% endif %}
            <div class="col-xl-12">
                <form class="form-signin" method="POST" action="{% url 'insert_report' %}" id="form_report">
                    {% csrf_token %}
                    <div class="row justify-content-center">
                        <div class="col-xl-7">
                            <div class="row justify-content-center">
                                <label for="example-text-input" class="col-md-3 text-right">Tipo de
                                    Reporte:</label>
                                <div class="col-md-9">
                                    <select id="list_type_report"
                                            class="combobox input-large form-control form-control-sm"
                                            name="list_type_report">
                                        <option value="0" selected="selected">-- Seleccionar --</option>
                                        {% for report in type_report %}
                                            <option value="{{ report.ID }}">{{ report.TIPO_REPORTE }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <label for="example-text-input" class="col-md-3 text-right">Sub Reporte:</label>
                                <div class="col-md-9">
                                    <select id="list_sub_report"
                                            class="combobox input-large form-control form-control-sm"
                                            name="list_sub_report">
                                        <option value="0" selected="selected">-- Seleccionar --</option>
                                    </select>
                                </div>
                                <label for="example-text-input" class="col-md-3 text-right">Accion:</label>
                                <div class="col-md-9">
                                    <select id="list_action_report"
                                            class="combobox input-large form-control form-control-sm"
                                            name="list_action_report">
                                        <option value="0" selected="selected">-- Seleccionar --</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <hr>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" name="option"
                                                   id="radios1"
                                                   value="0">
                                            Reporte a RN
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" name="option"
                                                   id="radios2"
                                                   value="1">
                                            Tarjeta WIN-TV entregada a RN
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" name="option"
                                                   id="radios3"
                                                   value="2">
                                            Disco duro entregadio a RN
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" name="option"
                                                   id="radios4"
                                                   value="3">
                                            CPU entregada a RN
                                        </label>
                                    </div>
                                </div>
                                <label for="example-text-input" class="col-md-12">Comentarios:</label>
                                <div class="col-md-12">
                                            <textarea class="form-control" id="commentArea" name="commentArea"
                                                      rows="3"></textarea>
                                </div>
                                <div class="col-md-12">
                                    <br>
                                </div>
                                <a class="btn btn-lg btn-primary mr-sm-2" onclick="javascript:buttonForm()">
                                    Guardar
                                </a>
                                <a class="btn btn-lg btn-danger mr-sm-2" href="{% url 'start_tracing' %}">
                                    Regresar
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
                {% if history %}
                    <div class="col-xl-12 text-right" style="color: #aa0000">
                        <br>
                        Reporte levantado el {{ details }}
                    </div>
                {% endif %}
            </div>
            {% if history %}
                </div>
                <div class="tab-pane fade" id="historical" role="tabpanel" aria-labelledby="profile-tab">
                    <div class="col-xl-12">
                        <table class="table cell-border" id="datatable" cellspacing="0"
                               width="100%">
                            <thead>
                            <tr align="center">
                                <th><strong>TIPO REPORTE</strong></th>
                                <th><strong>SUB REPORTE</strong></th>
                                <th><strong>ACCION</strong></th>
                                <th><strong>ESTADO</strong></th>
                                <th><strong>COMENTARIO</strong></th>
                                <th><strong>USUARIO</strong></th>
                                <th><strong>FECHA</strong></th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            {% endif %}
        </div>
    </div>
    <!-- Modal message -->
    <div id="modalmessage" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmaci&#243;n</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Esta seguro de realizar un reporte, para el testigo con nombre
                        {% for data in witness %}{{ data.NOMBRE_TESTIGO }}{% endfor %}.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="javascript:buttonConfirmation()">Aceptar
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block additionalfooterexternalbefore %}
    <script>window.jQuery || document.write('<script src="{%  static '/assets/js/vendor/jquery.min.js' %}"><\/script>')</script>
{% endblock %}
{% block additionalfooterexternalafter %}
    {% if history %}
        <script type="text/javascript" src="{% static 'dist/js/jquery.dataTables.js' %}" charset="UTF-8"></script>
        <script type="text/javascript" src="{% static 'dist/js/dataTables.select.js' %}" charset="UTF-8"></script>
        <script type="text/javascript" src="{% static 'dist/js/dataTables.searchHighlight.min.js' %}"
                charset="UTF-8"></script>
        <script type="text/javascript" src="{% static 'dist/js/jquery.highlight.js' %}" charset="UTF-8"></script>
    {% endif %}
    <script type="text/javascript" src="{% static '/dist/js/bootstrap-combobox.js' %}" charset="UTF-8"></script>
{% endblock %}
{% block javascript %}
    <script type="text/javascript" charset="UTF-8">

        /**
         * Created by Jose Daniel Hernandez Osorio - isc.danielosorio@hotmail.com -
         * Ingeniero en Sistemas Copmutacionales.
         */

        $(document).ready(
            function () {

                $("#list_type_report").change(function () {
                    list_sub_report();
                    list_action_report();
                });

                $("#list_sub_report").change(function () {
                });

                $("#list_action_report").change(function () {
                });
                {% if history %}
                    var data = search();
                    update(data);
                {% endif %}
            });

        function list_sub_report() {
            return JSON.parse($.ajax({
                type: "GET",
                url: "{% url 'list_sub_report' %}",
                data: {
                    type: getTypeReport()
                },
                dataType: 'json',
                async: false,
                success: function (data) {
                    var options = '<option value="0" selected="selected">-- Seleccionar --</option>';
                    for (var i in data) {
                        options += '<option value="' + data[i]['ID'] + '">' + data[i]['SUB_REPORTE'] + '</option>';
                    }
                    $("#list_sub_report").html(options);
                    $("#list_sub_report").trigger("change");
                }
            }).responseText);
        }

        function list_action_report() {
            return JSON.parse($.ajax({
                type: "GET",
                url: "{% url 'list_action_report' %}",
                data: {
                    type: getTypeReport()
                },
                dataType: 'json',
                async: false,
                success: function (data) {
                    var options = '<option value="0" selected="selected">-- Seleccionar --</option>';
                    for (var i in data) {
                        options += '<option value="' + data[i]['ID'] + '">' + data[i]['ACCION'] + '</option>';
                    }
                    $("#list_action_report").html(options);
                    $("#list_action_report").trigger("change");
                }
            }).responseText);
        }
        {% if history %}
            function search() {
                return JSON.parse($.ajax({
                    type: "GET",
                    url: "{% url 'list_history' %}",
                    data: {
                        {% for data in witness %}id_witness: {{ data.ID_TESTIGO }}{% endfor %}
                    },
                    dataType: 'json',
                    async: false,
                    success: function (data) {
                        if (data["error"])
                            location.reload(true);
                        return data;
                    }
                }).responseText);
            }

            function update(datas) {

                var table = $('#datatable').DataTable();
                table.destroy();

                $('#datatable').DataTable({
                    "language": {
                        select: {
                            rows: {
                                _: "%d filas seleccionadas",
                                0: "Haga click en la fila para seleccionar",
                                1: "1 fila seleccionada"
                            }
                        },
                        "url": "https://cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json"
                    },
                    "searchHighlight": true,
                    "scrollX": true,
                    "select": true,
                    "bLengthChange": false,
                    "processing": true,
                    "data": datas,
                    "pageLength": 20,
                    "sDom": '<"row"<"col-sm-3 text-center"f><"col-sm-9 text-center"p>>rti',
                    "columns": [
                        {"data": "TIPO_REPORTE"},
                        {"data": "SUB_REPORTE"},
                        {"data": "ACCION"},
                        {"data": "ESTADO"},
                        {"data": "COMENTARIO"},
                        {"data": "NOMBRE"},
                        {"data": "FECHA"}
                    ],
                    "columnDefs": [{
                        className: "text-center folio",
                        "targets": [0]
                    }, {
                        className: "text-center",
                        "targets": [1]
                    }, {
                        className: "text-center",
                        "targets": [2]
                    }, {
                        className: "text-center",
                        "targets": [3]
                    }, {
                        className: "text-center",
                        "targets": [4]
                    }, {
                        className: "text-center",
                        "targets": [5]
                    }, {
                        className: "text-center",
                        "targets": [6]
                    }],
                    "select": {
                        style: "single"
                    },
                    "order": [[2, "asc"]]
                });
            }
        {% endif %}
        function getTypeReport() {
            var date = $('select[id=list_type_report]').val();
            return date;
        }

        function getSubReport() {
            var date = $('select[id=list_sub_report]').val();
            return date;
        }

        function getActionReport() {
            var date = $('select[id=list_action_report]').val();
            return date;
        }

        function buttonForm() {
            if (getTypeReport() == 0 || getSubReport() == 0) {
                alert("Para Crear un Reporte es necesario como minimo ingresar \"Tipo de Reporte\" y \"Sub Reporte\"");
            } else {
                $("#modalmessage").modal('show');
            }
        }

        function buttonConfirmation() {
            document.forms['form_report'].submit();
        }

    </script>
{% endblock %}